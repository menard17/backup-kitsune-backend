import pytest
from cryptography import x509
from cryptography.hazmat.primitives.serialization import (
    BestAvailableEncryption,
    load_pem_private_key,
)
from cryptography.hazmat.primitives.serialization.pkcs12 import (
    serialize_key_and_certificates,
)

from utils.requests_pkcs12 import Pkcs12Adapter

# this valid cert will be expired on year 9999
VALID_CERT_KEY = """
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCuxlswdY1mKjtc
HfD9jyoVN+gaQYxY4U05mHu6385WDL++ySKfWa65OiPwlEfcNL0m185rClacIYHs
ViaT71bJqb4iNYCdHOOGrodXbFyeazhrbCcNXmWZWf4MFV4ElXLZjCayveGb4yap
WRrBeEP+xeH7Me5yRpZJvqqUlVSl7pqPZy+GbJsG667LE54jw1LQT3SDUW9l9fGj
khG2pGjwWuThY//pztlK2xKXXn+/jNmR356etImrLcRJYqBPwLfsQYXe/yipJSCT
mWr95R1aZ7GH9EcxOaMfHZhhsrNt8yR4x6ItBkOmN/LkNoNC1DtoKAKjojAjAG4U
NRrMgeoTAgMBAAECggEBAIOx9a6rNXQBaJ899ISrpxM8AEogkEe85Xr72mfzEsCm
dKmnV85pPo5WMBStNwTIPKuTO/hOXvrhCMx0Ejewxl3I6PtQA2zgAtZOlq8aeSPq
OSZA5aBePAJ03EhwpVqg3lztDY/sIp9bZ5t+B/o2zE2jAGhOtJUpeT9yS4kQiStK
RCXNWojaFJm7q9U8QluKUktFTSpmWOgMUaXtFtMMY/pITQkcgQy97T3ttIUtP/Is
BRWx99Sx0fzk2zlmdFJYv6C60XsIBXdsxlsl2Mfb+Sq55hk7cNMCShV2HJ5VgYQg
gheCTBkb+lu5GFRc64fyATad7xI+R8SzyiJ9ph5fa4kCgYEA1QaI9ghy3uE0A8/C
acIEnfYzPb9f8PpjzWcnOkHiae37quPasL4bKHCVHnbxZ4WQxODzKibMvcM00STv
LStJhe6xSPDzEdNiwrJtJhzCX0A7COjhk1gXdMEqkqQ+BCX7o/RFHogTplHKy879
5wosJ9FzaLrAIC3Enai/nbEc+PUCgYEA0ghoHHtFgGMyq5K66b56O3S1azFD8s8D
iDfMv1REzEUvzUpuvZaHMmfuQl5yx+NpneWPuKuiBu//gG9y+r7qnH9zX2DNWvst
By2Wujmt4AHIlUIxunHuMh8ZC+LM6/zAoOmDJL6VAVSDHJfluWsKvgDYtDj9N0X0
nktkW5JhEecCgYA/jmiUhybGiog7TuQhK4q3GjplhNB6FCpsoQcaIYgMtL0uWjbo
Hn/5y8Uhxrj1eusbYkYKYHMbdr8uWwelAVI5TGLGcWUD/35qulNIWLJBOueiG+EZ
VeIBqpQqFiiOkkqGux1YI59BMwv/TK2CHg3Yf2wgZf9mWmFb7Hnm8W3EdQKBgBvj
Xd+aRqo7gbjibMsorZZDcuteyUTuU+u8bQVirRfqf+RkY7vsxtrcjfhmDhuYiKec
ma7Nq1/8chKducitnP1Wtv0NH3dbLqlrVj439mxuEDIxbeTxx80D8BFx9f/HudQj
7XPtkl9w10/uo2QxYGXGOwADKSwzr71tCVBXaWg1AoGAJwhG7AqTw/bQ6C/OLH8h
LQnnOBOxdqO8cQ4wO/PZ6nuuRCuGejL/J+zYSRO2dEB1WlZTkAIEajrk+aQIOgn5
Or5XMCmyz2r8eNzfEY8hI/NrOT3Til4t21SlTH7w3z+G1sxZXyYtR6nTnsoLEWg7
m1bPJ/UuO0GHXStiWT2w7RY=
-----END PRIVATE KEY-----
"""

VALID_CERT = """
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCuxlswdY1mKjtc
HfD9jyoVN+gaQYxY4U05mHu6385WDL++ySKfWa65OiPwlEfcNL0m185rClacIYHs
ViaT71bJqb4iNYCdHOOGrodXbFyeazhrbCcNXmWZWf4MFV4ElXLZjCayveGb4yap
WRrBeEP+xeH7Me5yRpZJvqqUlVSl7pqPZy+GbJsG667LE54jw1LQT3SDUW9l9fGj
khG2pGjwWuThY//pztlK2xKXXn+/jNmR356etImrLcRJYqBPwLfsQYXe/yipJSCT
mWr95R1aZ7GH9EcxOaMfHZhhsrNt8yR4x6ItBkOmN/LkNoNC1DtoKAKjojAjAG4U
NRrMgeoTAgMBAAECggEBAIOx9a6rNXQBaJ899ISrpxM8AEogkEe85Xr72mfzEsCm
dKmnV85pPo5WMBStNwTIPKuTO/hOXvrhCMx0Ejewxl3I6PtQA2zgAtZOlq8aeSPq
OSZA5aBePAJ03EhwpVqg3lztDY/sIp9bZ5t+B/o2zE2jAGhOtJUpeT9yS4kQiStK
RCXNWojaFJm7q9U8QluKUktFTSpmWOgMUaXtFtMMY/pITQkcgQy97T3ttIUtP/Is
BRWx99Sx0fzk2zlmdFJYv6C60XsIBXdsxlsl2Mfb+Sq55hk7cNMCShV2HJ5VgYQg
gheCTBkb+lu5GFRc64fyATad7xI+R8SzyiJ9ph5fa4kCgYEA1QaI9ghy3uE0A8/C
acIEnfYzPb9f8PpjzWcnOkHiae37quPasL4bKHCVHnbxZ4WQxODzKibMvcM00STv
LStJhe6xSPDzEdNiwrJtJhzCX0A7COjhk1gXdMEqkqQ+BCX7o/RFHogTplHKy879
5wosJ9FzaLrAIC3Enai/nbEc+PUCgYEA0ghoHHtFgGMyq5K66b56O3S1azFD8s8D
iDfMv1REzEUvzUpuvZaHMmfuQl5yx+NpneWPuKuiBu//gG9y+r7qnH9zX2DNWvst
By2Wujmt4AHIlUIxunHuMh8ZC+LM6/zAoOmDJL6VAVSDHJfluWsKvgDYtDj9N0X0
nktkW5JhEecCgYA/jmiUhybGiog7TuQhK4q3GjplhNB6FCpsoQcaIYgMtL0uWjbo
Hn/5y8Uhxrj1eusbYkYKYHMbdr8uWwelAVI5TGLGcWUD/35qulNIWLJBOueiG+EZ
VeIBqpQqFiiOkkqGux1YI59BMwv/TK2CHg3Yf2wgZf9mWmFb7Hnm8W3EdQKBgBvj
Xd+aRqo7gbjibMsorZZDcuteyUTuU+u8bQVirRfqf+RkY7vsxtrcjfhmDhuYiKec
ma7Nq1/8chKducitnP1Wtv0NH3dbLqlrVj439mxuEDIxbeTxx80D8BFx9f/HudQj
7XPtkl9w10/uo2QxYGXGOwADKSwzr71tCVBXaWg1AoGAJwhG7AqTw/bQ6C/OLH8h
LQnnOBOxdqO8cQ4wO/PZ6nuuRCuGejL/J+zYSRO2dEB1WlZTkAIEajrk+aQIOgn5
Or5XMCmyz2r8eNzfEY8hI/NrOT3Til4t21SlTH7w3z+G1sxZXyYtR6nTnsoLEWg7
m1bPJ/UuO0GHXStiWT2w7RY=
-----END PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
MIICrjCCAZagAwIBAgIBADANBgkqhkiG9w0BAQsFADASMRAwDgYDVQQDDAd1bWVk
LmpwMCAXDTIyMTIxMjEyMDAwMFoYDzk5OTkxMjEyMTIwMDAwWjASMRAwDgYDVQQD
DAd1bWVkLmpwMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEArsZbMHWN
Zio7XB3w/Y8qFTfoGkGMWOFNOZh7ut/OVgy/vskin1muuToj8JRH3DS9JtfOawpW
nCGB7FYmk+9Wyam+IjWAnRzjhq6HV2xcnms4a2wnDV5lmVn+DBVeBJVy2Ywmsr3h
m+MmqVkawXhD/sXh+zHuckaWSb6qlJVUpe6aj2cvhmybBuuuyxOeI8NS0E90g1Fv
ZfXxo5IRtqRo8Frk4WP/6c7ZStsSl15/v4zZkd+enrSJqy3ESWKgT8C37EGF3v8o
qSUgk5lq/eUdWmexh/RHMTmjHx2YYbKzbfMkeMeiLQZDpjfy5DaDQtQ7aCgCo6Iw
IwBuFDUazIHqEwIDAQABow0wCzAJBgNVHRMEAjAAMA0GCSqGSIb3DQEBCwUAA4IB
AQCCGF0UmRsEC0W8v32F1HW7MB2iDa+nwqwoRiLk/k7uhxSmhZN886YElPGK7qHL
FFGZUeajhZ79Zvuglri7xD7kRoLR7F5ON77b4uz2gitfFRbm9AIy4vATY0n0dyf1
yo/bn0Fv5oCFWcbY3waD5YoWp7Wxtk30mN7ttUAd3gfcTl4ayh2YRb7QBRHdm4g9
Shi1OZVtij9wwZXJD5wZgxOXazGv7EY1opyh3YATlfF4uc62whmLKrgLZyVG4kRW
8PBR/qWfUSJXgHARL9m4Pvmd2JwyMO5d6C+cwUSBF6sUTIEIwWJfbVTbKpJRaccC
kB82ucz1sVZPDqM5rpCFfLEW
-----END CERTIFICATE-----
"""
# this invalid cert has been expired on year 1990
INVALID_CERT_KEY = """
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDTbll5I8f3S3wc
T8m9mRi86PwUTwwcqRqCPYl5xi/7eyaa/mIpaMh9Ka7cC7bcuLLqJUOID9UMaYhb
Q34h5gQG0808FViApNYaA9YBX+jtpmXVtU7QyKixHocrRp3+CRLWrcpFWwr0eReA
mULJi/Ev/VCtljs6mhoVD/w5kwzjwi/Er0NwUIJLhhEXmDUfLH5J+JCHdPTxPRwR
pU7nJTc9IBSKgHv9e6WNwVAqepsl5W7ttINua21P9i30sHrnEjT+SFCgx0uv1/kr
Dnu0nwCphtDAsD67eG0+slo9MZfjseg8g3SdJkvk7l51uWOjPZYN7Zk3YXpDJgrG
McXkEvk/AgMBAAECggEAe/KxGUdUrzDdbWuJBVF/IyAix3Uf0J2CIOAae/0nm/Iy
S6LdwRDgmB+blvx3EyZkHMgDsvw1FbW4bmg+xXim26nHI3YQEDqSGWYuS1gCoW9v
O72ymstHua3/5+raLFb9aEUx0z7wSSnEEWvHr4gOuOd0KI9t4Yj9yWM5pjcC03Gu
QGRKA9eaRJb+GaIG6tICQYvgfrieknP61eT/fSc0V9wnWCp+Pwu226lhD9PAvz8G
1k7Hu8N83qqh3SzOq2E8Z/Zmqio6KIhPHhsXnRgz4hQh1zmyLuczlqCMzHjsxr6J
Py3Hx07KCGyvgISHDXe0nfjcK/K7PU8gO9wV/rZ7IQKBgQD5u2VPjH+WOwkl8wDy
KE6ayoA+ahI0c4vHZ34Y/r0JmVzSZ1rkcYpU+L6+dOoKef5q9Bf2JlsTTqHfEn39
CcoibiLtTCncoEC7FB8KTftrNdeA1W6WAVz50XPcJsRgB1Z0EKgkIfp1chjrbQz/
Bpk9+Cc3KUDAojW9RKdbfhRhFQKBgQDYvNvBCReypyymKU68VeC06W1hKANF5PSK
W4dPsYLLYIqFFkLk2ysV1+8AT20BqMkY43qb+hVAYKScBJ1losCtg640tgZj7aU1
/2mwFkg2Jyog9gb8pxFi3Pi++vZ4wzObofYv9R4FygYJsa2zrWozUdco9aQnyMul
GAUqfjf+AwKBgE36pffg9zYB2SlwZ6s1ytWqxcC3flfCfLMXLdjAMmb87G8Gtur+
SSOfSHBQMYRz822SKqlB8M5mj0UIkS6iD+wQV/ehALFTmOLRtZ+SGh+wAErKWm2c
n1uie3sS397ca7JyQQ6HTZ2+sulQc+5uMQuYoSYoS3/bJsyi019OTy7BAoGAchT2
luTyVFcqaUvU5c1OOeukZz9oeaHKFgmXb5s//U0TnHnbPBsg0p6WbtNfzT/Kmg8i
uncoOHqmKnlDX/wK70ogqB4nvvGXxJRsTQNtfxOeWTsm8lX+EMu/Isd2dJpKz+Cw
dQ3Qf7uW8gNUKv9cpyas2iJyBX7rsjqyfWtyjYECgYEA5EjD9+bg0sF34+RRYZxQ
EZa8gJJjCHdXccX99kEjzXkqgoFA94UhEQN4dt5/odSI5dk9vAuSYqhrTAr2FAXc
Mn1Xizdlph0gRnO05qearpNfiRzJUNFjo5zDANMUtW+HIY+bF6y+Tb7IlJuNdML9
J+V5gVnDdf1i13JLUBlUoPU=
-----END PRIVATE KEY-----
"""

INVALID_CERT = """
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDTbll5I8f3S3wc
T8m9mRi86PwUTwwcqRqCPYl5xi/7eyaa/mIpaMh9Ka7cC7bcuLLqJUOID9UMaYhb
Q34h5gQG0808FViApNYaA9YBX+jtpmXVtU7QyKixHocrRp3+CRLWrcpFWwr0eReA
mULJi/Ev/VCtljs6mhoVD/w5kwzjwi/Er0NwUIJLhhEXmDUfLH5J+JCHdPTxPRwR
pU7nJTc9IBSKgHv9e6WNwVAqepsl5W7ttINua21P9i30sHrnEjT+SFCgx0uv1/kr
Dnu0nwCphtDAsD67eG0+slo9MZfjseg8g3SdJkvk7l51uWOjPZYN7Zk3YXpDJgrG
McXkEvk/AgMBAAECggEAe/KxGUdUrzDdbWuJBVF/IyAix3Uf0J2CIOAae/0nm/Iy
S6LdwRDgmB+blvx3EyZkHMgDsvw1FbW4bmg+xXim26nHI3YQEDqSGWYuS1gCoW9v
O72ymstHua3/5+raLFb9aEUx0z7wSSnEEWvHr4gOuOd0KI9t4Yj9yWM5pjcC03Gu
QGRKA9eaRJb+GaIG6tICQYvgfrieknP61eT/fSc0V9wnWCp+Pwu226lhD9PAvz8G
1k7Hu8N83qqh3SzOq2E8Z/Zmqio6KIhPHhsXnRgz4hQh1zmyLuczlqCMzHjsxr6J
Py3Hx07KCGyvgISHDXe0nfjcK/K7PU8gO9wV/rZ7IQKBgQD5u2VPjH+WOwkl8wDy
KE6ayoA+ahI0c4vHZ34Y/r0JmVzSZ1rkcYpU+L6+dOoKef5q9Bf2JlsTTqHfEn39
CcoibiLtTCncoEC7FB8KTftrNdeA1W6WAVz50XPcJsRgB1Z0EKgkIfp1chjrbQz/
Bpk9+Cc3KUDAojW9RKdbfhRhFQKBgQDYvNvBCReypyymKU68VeC06W1hKANF5PSK
W4dPsYLLYIqFFkLk2ysV1+8AT20BqMkY43qb+hVAYKScBJ1losCtg640tgZj7aU1
/2mwFkg2Jyog9gb8pxFi3Pi++vZ4wzObofYv9R4FygYJsa2zrWozUdco9aQnyMul
GAUqfjf+AwKBgE36pffg9zYB2SlwZ6s1ytWqxcC3flfCfLMXLdjAMmb87G8Gtur+
SSOfSHBQMYRz822SKqlB8M5mj0UIkS6iD+wQV/ehALFTmOLRtZ+SGh+wAErKWm2c
n1uie3sS397ca7JyQQ6HTZ2+sulQc+5uMQuYoSYoS3/bJsyi019OTy7BAoGAchT2
luTyVFcqaUvU5c1OOeukZz9oeaHKFgmXb5s//U0TnHnbPBsg0p6WbtNfzT/Kmg8i
uncoOHqmKnlDX/wK70ogqB4nvvGXxJRsTQNtfxOeWTsm8lX+EMu/Isd2dJpKz+Cw
dQ3Qf7uW8gNUKv9cpyas2iJyBX7rsjqyfWtyjYECgYEA5EjD9+bg0sF34+RRYZxQ
EZa8gJJjCHdXccX99kEjzXkqgoFA94UhEQN4dt5/odSI5dk9vAuSYqhrTAr2FAXc
Mn1Xizdlph0gRnO05qearpNfiRzJUNFjo5zDANMUtW+HIY+bF6y+Tb7IlJuNdML9
J+V5gVnDdf1i13JLUBlUoPU=
-----END PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
MIICrDCCAZSgAwIBAgIBADANBgkqhkiG9w0BAQsFADASMRAwDgYDVQQDDAd1bWVk
LmpwMB4XDTk4MTIxMjEyMDAwMFoXDTk5MTIxMjEyMDAwMFowEjEQMA4GA1UEAwwH
dW1lZC5qcDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBANNuWXkjx/dL
fBxPyb2ZGLzo/BRPDBypGoI9iXnGL/t7Jpr+YiloyH0prtwLtty4suolQ4gP1Qxp
iFtDfiHmBAbTzTwVWICk1hoD1gFf6O2mZdW1TtDIqLEehytGnf4JEtatykVbCvR5
F4CZQsmL8S/9UK2WOzqaGhUP/DmTDOPCL8SvQ3BQgkuGEReYNR8sfkn4kId09PE9
HBGlTuclNz0gFIqAe/17pY3BUCp6myXlbu20g25rbU/2LfSweucSNP5IUKDHS6/X
+SsOe7SfAKmG0MCwPrt4bT6yWj0xl+Ox6DyDdJ0mS+TuXnW5Y6M9lg3tmTdhekMm
CsYxxeQS+T8CAwEAAaMNMAswCQYDVR0TBAIwADANBgkqhkiG9w0BAQsFAAOCAQEA
D6WFZKrb1SoWFzsh/S8FYhDePTPhdR8JhV21o8XEyVhrfG8mc/zmk5ROAIAiEF13
340DKxJK0UjgWNFbzjvdu0jc00vfGRxPJ6R/pvRm2tawkJrjInFJdo1bmYZoaWlh
fUAzf4ckhMiwOcIAPjDj/R/kvVIfdjOomyuROLA1+u2rTGpDsCQfTlppj9XpqayV
7w9PI674p8Rn4cyepBnejif8Ou8MgF+eDw/Ukheo/cjk/cnEyn2EEoeBC11e8hyG
CegujnToNnj44Px5rMaR9Bxg76FdxmeYg7uqn9aLp/FHOAeKeiP8HJ6W58y7n+tb
g6nAcd8XLFWTIMLEIDZKgA==
-----END CERTIFICATE-----
"""


def test_Pkcs12Adapter_happy_path():
    """
    Once create Pkcs12Adapter instance, automatically called both create_ssl_sslcontext and check_cert_not_expired function.
    """
    key_bytes = bytes(VALID_CERT_KEY, "utf-8")
    cert_bytes = bytes(VALID_CERT, "utf-8")
    key = load_pem_private_key(key_bytes, None)
    cert = x509.load_pem_x509_certificate(cert_bytes)
    pkcs12_data = serialize_key_and_certificates(
        b"orca_cert", key, cert, None, BestAvailableEncryption(b"pass")
    )
    result = Pkcs12Adapter(pkcs12_data=pkcs12_data, pkcs12_password=b"pass")

    # if everything is fine, result has ssl_context properly
    assert result.ssl_context is not None


def test_Pkcs12Adapter_failed_with_invalid_cert():
    key_bytes = bytes(INVALID_CERT_KEY, "utf-8")
    cert_bytes = bytes(INVALID_CERT, "utf-8")
    key = load_pem_private_key(key_bytes, None)
    cert = x509.load_pem_x509_certificate(cert_bytes)
    pkcs12_data = serialize_key_and_certificates(
        b"orca_cert", key, cert, None, BestAvailableEncryption(b"pass")
    )
    # if everything is not fine, rise ValueError
    with pytest.raises(ValueError):
        Pkcs12Adapter(pkcs12_data=pkcs12_data, pkcs12_password=b"pass")
